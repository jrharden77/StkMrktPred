<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quant Trading Dashboard</title>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --text: #c9d1d9; --green: #238636; --blue: #58a6ff; --orange: #d29922; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Courier New', monospace; margin: 0; padding: 20px; }
        .container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 95vh; }
        
        /* Control Panel */
        .controls { background: var(--panel); padding: 20px; border-radius: 8px; border: 1px solid #30363d; overflow-y: auto; }
        h2 { color: var(--blue); margin-top: 0; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9em; }
        input[type="text"], input[type="number"] { 
            width: 100%; background: #0d1117; border: 1px solid #30363d; color: white; padding: 8px; margin-top: 5px; border-radius: 4px; 
        }
        button { 
            width: 100%; background: var(--green); color: white; border: none; padding: 15px; 
            margin-top: 25px; cursor: pointer; font-weight: bold; font-size: 1.1em; border-radius: 6px; 
        }
        button#ingestBtn { background: var(--orange); margin-top: 10px; font-size: 0.9em; padding: 10px; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #555; cursor: not-allowed; }

        /* Output Area */
        .output-area { display: grid; grid-template-rows: 1fr 150px; gap: 20px; }
        
        /* Terminal */
        .terminal { 
            background: #000; border: 1px solid #30363d; padding: 15px; border-radius: 8px; 
            overflow-y: scroll; font-size: 0.9em; line-height: 1.4; color: #0f0; 
            box-shadow: inset 0 0 20px rgba(0,255,0,0.1);
        }
        .terminal p { margin: 0; }
        
        /* Report Card */
        .report { background: var(--panel); border: 1px solid var(--blue); padding: 20px; border-radius: 8px; display: flex; justify-content: space-around; align-items: center; }
        .stat { text-align: center; }
        .stat-val { font-size: 2em; font-weight: bold; color: white; }
        .stat-label { font-size: 0.8em; color: #8b949e; text-transform: uppercase; }
        .win { color: #2ea043; } .loss { color: #da3633; }
    </style>
</head>
<body>

<div class="container">
    <!-- Sidebar Controls -->
    <div class="controls">
        <h2>‚öôÔ∏è Configuration</h2>
        
        <p style="color: #8b949e; font-size: 0.8em;">
            Running <b>Robust Ladder Strategy</b> with 100+ Hardcoded Stocks across 3 Equity Tiers.
        </p>
        
        <button id="ingestBtn" onclick="runIngestion()">üì• INGEST DATA (Run First)</button>
        
        <label>Backtest History (Months)</label>
        <input type="number" id="monthsBack" value="3">
        
        <label>Initial Capital ($)</label>
        <input type="number" id="initialCash" value="10000">
        
        <label>Risk Management</label>
        <div style="display: flex; gap: 10px;">
            <div style="flex:1">Stop Loss %<input type="number" id="stopLoss" value="5"></div>
            <div style="flex:1">Take Profit %<input type="number" id="takeProfit" value="10"></div>
        </div>
        
        <label>Position Sizing</label>
        <div style="display: flex; gap: 10px;">
             <div style="flex:1">Risk Per Trade %<input type="number" id="riskPerTrade" value="2"></div>
        </div>

        <label>Machine Learning</label>
        <div style="display: flex; gap: 10px;">
            <div style="flex:1">Estimators<input type="number" id="rfEstimators" value="200"></div>
            <div style="flex:1">Max Depth<input type="number" id="rfDepth" value="10"></div>
        </div>

        <button id="runBtn" onclick="runSimulation()">RUN SIMULATION</button>
        <div id="timerDisplay" style="margin-top: 10px; text-align: center; color: #8b949e; font-size: 0.9em; font-weight: bold;"></div>
    </div>

    <!-- Right Side -->
    <div class="output-area">
        <div class="terminal" id="terminal">
            <p>Ready to initialize...</p>
        </div>
        
        <div class="report">
            <div class="stat">
                <div class="stat-label">Final Equity</div>
                <div class="stat-val" id="resEquity">---</div>
            </div>
            <div class="stat">
                <div class="stat-label">Total Return</div>
                <div class="stat-val" id="resReturn">---</div>
            </div>
        </div>
    </div>
</div>

<script>
    const term = document.getElementById('terminal');

    async function runIngestion() {
        const btn = document.getElementById('ingestBtn');
        btn.disabled = true;
        btn.innerText = "INGESTING...";
        term.innerHTML = "<p>Connecting to Data Feed...</p>";
        
        try {
            await streamResponse('/ingest_data', {});
        } catch (e) {
            term.innerHTML += `<p style="color:red">[ERROR] ${e}</p>`;
        } finally {
            btn.disabled = false;
            btn.innerText = "üì• INGEST DATA (Run First)";
        }
    }

    async function runSimulation() {
        const btn = document.getElementById('runBtn');
        const timerDisplay = document.getElementById('timerDisplay');
        const inputs = document.querySelectorAll('input:not([type=button])');
        
        btn.disabled = true;
        btn.innerText = "PROCESSING...";
        term.innerHTML = "<p>Initializing connection...</p>";
        
        const startTime = Date.now();
        timerDisplay.innerText = "Time Elapsed: 0.0s";
        const timerInterval = setInterval(() => {
             const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
             timerDisplay.innerText = `Time Elapsed: ${elapsed}s`;
        }, 100);
        
        const payload = {};
        inputs.forEach(i => payload[i.id] = i.value);
        
        try {
            await streamResponse('/run_simulation', payload);
            
            clearInterval(timerInterval);
            const totalTime = ((Date.now() - startTime) / 1000).toFixed(2);
            term.innerHTML += `<p style="color:#58a6ff; margin-top:10px; border-top:1px dashed #30363d; padding-top:10px;">‚è±Ô∏è TOTAL EXECUTION TIME: ${totalTime} seconds</p>`;
            term.scrollTop = term.scrollHeight;
            
        } catch (e) {
            clearInterval(timerInterval);
            term.innerHTML += `<p style="color:red">[ERROR] ${e}</p>`;
        } finally {
            btn.disabled = false;
            btn.innerText = "RUN SIMULATION";
        }
    }

    async function streamResponse(endpoint, payload) {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n\n');
            
            lines.forEach(line => {
                if (line.startsWith('data: ')) {
                    const msg = line.replace('data: ', '');
                    
                    if (msg.startsWith('REPORT_JSON:')) {
                        const data = JSON.parse(msg.replace('REPORT_JSON:', ''));
                        document.getElementById('resEquity').innerText = data.equity;
                        const rEl = document.getElementById('resReturn');
                        rEl.innerText = data.return;
                        rEl.className = data.return.includes('-') ? 'stat-val loss' : 'stat-val win';
                    } else if (msg === '[DONE]') {
                        // handled in finally
                    } else {
                        const p = document.createElement('p');
                        p.innerText = msg;
                        term.appendChild(p);
                        term.scrollTop = term.scrollHeight; 
                    }
                }
            });
        }
    }
</script>
</body>
</html>